# è§£ææµè§ˆå™¨å¯¼å‡ºçš„ä¹¦ç­¾æ–‡ä»¶

åœ¨æˆ‘ä»¬æ—¥å¸¸çš„ç½‘ç»œæ´»åŠ¨ä¸­ï¼Œæˆ‘ä»¬æ¯å¤©éƒ½ä¼šæµè§ˆå¤§é‡çš„ç½‘é¡µï¼Œä¸ºäº†æ–¹ä¾¿ç®¡ç†å’Œä¿å­˜è¿™äº›ç½‘å€ï¼Œå‡ ä¹æ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æä¾›äº†â€œä¹¦ç­¾â€åŠŸèƒ½ã€‚è€Œå¯¼å‡ºä¹¦ç­¾æ–‡ä»¶ï¼Œæ˜¯ä¸€ç§å¤‡ä»½å’Œå…±äº«ä¹¦ç­¾çš„å¸¸è§åšæ³•ã€‚æœ¬æ–‡å°†å¸¦æ‚¨äº†è§£æµè§ˆå™¨å¯¼å‡ºçš„ä¹¦ç­¾æ–‡ä»¶çš„ç»“æ„å’Œå†…å®¹ï¼Œå¸®åŠ©æ‚¨æ›´å¥½åœ°ç†è§£ä¹¦ç­¾æ–‡ä»¶çš„æ ¼å¼ã€å†…å®¹å’Œå¯èƒ½çš„åº”ç”¨åœºæ™¯ã€‚

## ä¹¦ç­¾æ–‡ä»¶çš„æ ¼å¼

ä¹¦ç­¾æ–‡ä»¶æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨æµè§ˆå™¨ä¹¦ç­¾æ•°æ®çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå…¶é€šå¸¸é‡‡ç”¨ `HTML` æ ¼å¼ã€‚å®ƒåŒ…å«äº†æ‚¨åœ¨æµè§ˆå™¨ä¸­æ”¶è—çš„æ‰€æœ‰ç½‘å€çš„æ ‡é¢˜ã€`URL` å’Œå…¶ä»–ç›¸å…³ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¹¦ç­¾æ–‡ä»¶çš„ç¤ºä¾‹ï¼š

```html
<!DOCTYPE NETSCAPE-Bookmark-file-1>
<!-- This is an automatically generated file. -->
<DL><p>
    <DT><H3 ADD_DATE="1634454000" LAST_MODIFIED="1634454200" PERSONAL_TOOLBAR_FOLDER="true">ä¹¦ç­¾æ </H3>
    <DL><p>
        <DT><A HREF="https://www.example.com" ADD_DATE="1634454300" ICON="data:image/png;base64,..." LAST_MODIFIED="1634454320">ç¤ºä¾‹ç½‘ç«™</A>
        <!-- æ›´å¤šä¹¦ç­¾... -->
    </DL><p>
</DL><p>
```

ä¸»è¦çš„æ ‡ç­¾åŠå…¶å«ä¹‰å¦‚ä¸‹ï¼š

- `<DL>`ï¼šè¡¨ç¤ºåŒ…å«ä¹¦ç­¾åˆ—è¡¨çš„å¤§æ ‡ç­¾
- `<DT>`ï¼šåœ¨ `<DL>` å†…ï¼Œæ¯ä¸ªæ¡ç›®ä¸€ä¸ª `<DT>` æ ‡ç­¾
- `<H3>`ï¼šè¡¨ç¤ºä¹¦ç­¾æ–‡ä»¶å¤¹æ ‡é¢˜çš„æ ‡ç­¾
- `<A>`ï¼šè¡¨ç¤ºå•ä¸ªä¹¦ç­¾çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬ä¹¦ç­¾åç§°ã€`URL` ç­‰ä¿¡æ¯

`<H3>` å’Œ `<A>` æ ‡ç­¾ä¸­è¿˜åŒ…å«æ·»åŠ æ—¶é—´ã€æœ€åä¿®æ”¹æ—¶é—´ç­‰å…ƒä¿¡æ¯ã€‚

## å¦‚ä½•è§£æä¹¦ç­¾æ–‡ä»¶

è§£æä¹¦ç­¾æ–‡ä»¶æ—¶ï¼Œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:

1. è§£æä¹¦ç­¾æ–‡ä»¶ï¼Œéå†æ¯ä¸ª `<H3>` æ ‡é¢˜æ ‡ç­¾ï¼Œè·å¾—æ–‡ä»¶å¤¹ä¿¡æ¯
2. æ£€æŸ¥å…¶ç›¸é‚»çš„ `<DL>` æ ‡ç­¾ï¼Œè·å¾—æ–‡ä»¶å¤¹å†…çš„ä¹¦ç­¾åˆ—è¡¨
3. éå† `<DL>` å†…æ¯ä¸ª `<DT>` æ ‡ç­¾ï¼Œè·å¾—ä¹¦ç­¾è¯¦æƒ…
4. æ£€æŸ¥çˆ¶æ ‡ç­¾ï¼Œå¯»æ‰¾æ–‡ä»¶å¤¹çš„ä¸Šçº§ç›®å½•
5. é€šè¿‡é€’å½’ï¼Œå»ºç«‹ä¹¦ç­¾çš„ç›®å½•æ ‘ç»“æ„

æœ€ç»ˆï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªç±»ä¼¼ä»¥ä¸‹ç»“æ„çš„ `JSON` æ•°æ®ï¼š

```json
{
	"title": "ä¹¦ç­¾æ ",
	"bookmarks": [{
		"title": "ç¤ºä¾‹ç½‘ç«™",
		"url": "https://www.example.com",
		"addAt": "2021-10-17T15:05:00+08:00",
		"updateAt": "2021-10-17T15:05:20+08:00"
	}],
	"addAt": "2021-10-17T15:00:00+08:00",
	"updateAt": "2021-10-17T15:03:20+08:00"
}
```

### è§£æä¹¦ç­¾æ–‡ä»¶

```go
// parseBookmarks extracts bookmarks from the goquery document and returns a slice of bookmark entries.
func parseBookmarks(doc *goquery.Document) []Bookmark {
	// initialize a map to store bookmarks with their titles as keys.
	bookmarkMap := make(map[string]*Bookmark)

	// helper function to parse timestamp.
	parseTime := func(timestamp string) *time.Time {
		if len(timestamp) == 0 {
			return nil
		}
		ts, err := strconv.ParseInt(timestamp, 10, 64)
		if err != nil {
			fmt.Println("error parsing timestamp:", err.Error())
			return nil
		}
		t := time.Unix(ts, 0)
		return &t
	}

	// iterate over each H3 element in the document representing bookmark titles.
	doc.Find("H3").Each(func(i int, header *goquery.Selection) {
		// create a bookmark entry for the current H3 element.
		bookmark := Bookmark{
			Title:    header.Text(),
			AddAt:    parseTime(header.AttrOr("add_date", "")),
			UpdateAt: parseTime(header.AttrOr("last_modified", "")),
		}

		// check if the header has a sibling DL element containing bookmarks.
		if dlNode := header.Next(); dlNode.Is("DL") {
			// iterate over each DT element representing sub-bookmark titles.
			dlNode.ChildrenFiltered("DT").Each(func(j int, dtNode *goquery.Selection) {
				if aNode := dtNode.Children().First(); aNode.Is("A") {
					// create a bookmark entry for each bookmark within the DL element.
					subBookmark := Bookmark{
						Title:    aNode.Text(),
						URL:      aNode.AttrOr("href", ""),
						AddAt:    parseTime(aNode.AttrOr("add_date", "")),
						UpdateAt: parseTime(aNode.AttrOr("last_modified", "")),
					}
					bookmark.Bookmarks = append(bookmark.Bookmarks, subBookmark)
				}
			})
		}

		// check if the bookmark has a parent folder (H3 element).
		if parentDL := header.Parent().Parent(); parentDL.Is("DL") && parentDL.Prev().Is("H3") {
			// set the parent field for the current bookmark.
			bookmark.Parent = parentDL.Prev().Text()
		}

		// add the bookmark to the map.
		bookmarkMap[bookmark.Title] = &bookmark
	})

	// convert the map values to a slice and return.
	bookmarks := make([]Bookmark, 0, len(bookmarkMap))
	for _, bookmark := range bookmarkMap {
		bookmarks = append(bookmarks, *bookmark)
	}
	return bookmarks
}
```

### å»ºç«‹ä¹¦ç­¾çš„ç›®å½•æ ‘ç»“æ„

```go
// buildTree constructs the bookmark tree by finding the root folder and building the sub-trees.
func buildTree(bookmarks []Bookmark) Bookmark {
	// function to find the root folder by looking for a bookmark without a parent.
	findRootFolder := func(bookmarks []Bookmark) *Bookmark {
		for i := range bookmarks {
			if bookmarks[i].Parent == "" {
				return &bookmarks[i]
			}
		}
		return nil
	}

	root := findRootFolder(bookmarks)
	if root == nil {
		fmt.Println("root folder not found")
		return Bookmark{}
	}

	// function to build the sub-tree recursively.
	var buildSubTree func(parent *Bookmark)
	buildSubTree = func(parent *Bookmark) {
		for i := range bookmarks {
			if bookmarks[i].Parent == parent.Title {
				parent.Bookmarks = append(parent.Bookmarks, bookmarks[i])
				buildSubTree(&parent.Bookmarks[len(parent.Bookmarks)-1])
			}
		}
	}

	// build the sub-tree for the root folder.
	buildSubTree(root)
	return *root
}
```

å®Œæ•´å®ç°ä»£ç å·²ç»æäº¤åˆ° `GitHub`ï¼Œ[ç‚¹æ­¤æŸ¥çœ‹](https://github.com/2hangpeng/parse-bookmarks/blob/main/parse-bookmarks.go)ã€‚

## è§£æåçš„ä¹¦ç­¾æ•°æ®èƒ½åšä»€ä¹ˆ

ä¸€æ—¦æ‚¨æˆåŠŸè§£æäº†ä¹¦ç­¾æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å°†æ•°æ®åº”ç”¨äºå…¶ä»–ç”¨é€”ï¼Œæ¯”å¦‚ï¼š

- åˆ†ç±»å’Œæ•´ç†

   æ›´å¥½åœ°ç»„ç»‡å’Œç®¡ç†æˆ‘ä»¬çš„ä¹¦ç­¾åº“ï¼Œå¸®åŠ©æˆ‘ä»¬äº†è§£è‡ªå·±çš„æµè§ˆå…´è¶£å’Œåå¥½ï¼Œè¿›è€Œä¼˜åŒ–æ”¶è—å’Œæ•´ç†æ–¹å¼ã€‚

- å¤‡ä»½å’Œæ¢å¤

   å°†ä¹¦ç­¾å¤‡ä»½åˆ°æœ¬åœ°ï¼Œä»¥é˜²æµè§ˆå™¨æ•…éšœæˆ–æ›´æ¢è®¾å¤‡æ—¶ä¸¢å¤±ä¹¦ç­¾ã€‚

- è·¨æµè§ˆå™¨åŒæ­¥

   å¦‚æœæ‚¨åœ¨å¤šä¸ªæµè§ˆå™¨ä¸Šä½¿ç”¨ä¸åŒè´¦å·ï¼Œå¯ä»¥å°†ä¹¦ç­¾ä»ä¸€ä¸ªæµè§ˆå™¨å¯¼å‡ºï¼Œç„¶åå¯¼å…¥åˆ°å¦ä¸€ä¸ªæµè§ˆå™¨ï¼Œæ–¹ä¾¿åŒæ­¥ä¹¦ç­¾ã€‚

- åˆ†äº«å’Œåä½œ

   å°†ä¹¦ç­¾å¯¼å‡ºåï¼Œæ‚¨å¯ä»¥å°†ä¹¦ç­¾æ–‡ä»¶å‘é€ç»™æœ‹å‹æˆ–åŒäº‹ï¼Œè®©ä»–ä»¬ä¹Ÿèƒ½å¿«é€Ÿè®¿é—®åˆ°æ‚¨æ¨èçš„ç½‘é¡µã€‚

## æ€»ç»“

ä¹¦ç­¾æ˜¯æˆ‘ä»¬æ—¥å¸¸ç½‘ç»œæµè§ˆä¸å¯æˆ–ç¼ºçš„è¾…åŠ©å·¥å…·ï¼Œäº†è§£ä¹¦ç­¾æ–‡ä»¶çš„ç»“æ„å’Œå†…å®¹å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç®¡ç†ã€å¤„ç†å’Œåˆ©ç”¨è¿™äº›ä¹¦ç­¾æ•°æ®ã€‚æœ¬æ–‡è®²è§£äº†ä¹¦ç­¾æ–‡ä»¶çš„æ ¼å¼åŠå†…å®¹è§£ææ–¹æ³•,å¸Œæœ›å¯ä»¥å¸®åŠ©è¯»è€…æ›´å¥½åœ°ç®¡ç†æµè§ˆå™¨ä¸­çš„ä¹¦ç­¾æ•°æ®ã€‚æ„Ÿè°¢æ‚¨çš„é˜…è¯»!

######

å¦‚æœè§‰å¾—æœ¬ç¯‡æ–‡ç« ä¸é”™ï¼Œéº»çƒ¦ç»™ä¸ª**ç‚¹èµğŸ‘ã€æ”¶è—ğŸŒŸã€åˆ†äº«ğŸ‘Šã€åœ¨çœ‹ğŸ‘€**å››è¿ï¼

![å¹²è´§è¾“å‡ºæœº](https://img.zhangpeng.site/wechat/qrcode.jpg)
